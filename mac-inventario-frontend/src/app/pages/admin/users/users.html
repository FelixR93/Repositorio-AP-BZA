<div class="page">
  <!-- Header -->
  <div class="head">
    <div class="head-left">
      <div class="title-row">
        <h2>Usuarios</h2>
        <span class="chip">ADMIN</span>
        <span class="chip ghost">Gestión de accesos</span>
      </div>
      <div class="sub">Crea, edita, activa/desactiva o elimina usuarios del sistema.</div>
    </div>

    <div class="head-actions">
      <div class="searchbox">
        <span class="icon">⌕</span>
        <input class="search" [(ngModel)]="q" placeholder="Buscar por nombre, usuario o rol…" />
      </div>
      <button class="btn ghost" type="button" (click)="load()" [disabled]="loading">
        {{ loading ? 'Actualizando…' : 'Actualizar' }}
      </button>
    </div>
  </div>

  <!-- States -->
  <div *ngIf="loading" class="state loading">
    <div class="dot"></div>
    <div>
      <div class="state-title">Cargando usuarios</div>
      <div class="state-sub">Sincronizando con el servidor…</div>
    </div>
  </div>

  <div *ngIf="!loading && error" class="state error">
    <div>
      <div class="state-title">No se pudo cargar</div>
      <div class="state-sub">{{ error }}</div>
    </div>
  </div>

  <div class="grid" *ngIf="!loading">
    <!-- Crear -->
    <div class="card">
      <div class="card-head">
        <div>
          <div class="card-title">Crear usuario</div>
          <div class="card-sub">Define credenciales y rol de acceso</div>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Nombre completo</label>
          <input [(ngModel)]="createForm.fullName" placeholder="Ej: Carlos Sánchez" />
        </div>

        <div class="field">
          <label>Usuario</label>
          <input [(ngModel)]="createForm.username" placeholder="Ej: csanchez" />
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Contraseña</label>
          <input [(ngModel)]="createForm.password" type="password" placeholder="********" />
        </div>

        <div class="field">
          <label>Rol</label>
          <select [(ngModel)]="createForm.role">
            <option [ngValue]="'USER'">USER</option>
            <option [ngValue]="'ADMIN'">ADMIN</option>
          </select>
        </div>
      </div>

      <div class="inline-err" *ngIf="error && !creating">{{ error }}</div>

      <button class="btn primary" type="button" (click)="create()" [disabled]="creating">
        <span class="spin" *ngIf="creating"></span>
        {{ creating ? 'Creando…' : 'Crear usuario' }}
      </button>
    </div>

    <!-- Listado -->
    <div class="card">
      <div class="card-head">
        <div>
          <div class="card-title">Listado</div>
          <div class="card-sub">Usuarios registrados ({{ filtered.length }})</div>
        </div>
      </div>

      <div *ngIf="filtered.length === 0" class="empty">
        No hay usuarios que coincidan con tu búsqueda.
      </div>

      <div class="table" *ngIf="filtered.length > 0">
        <table>
          <thead>
            <tr>
              <th>Nombre</th>
              <th>Usuario</th>
              <th>Rol</th>
              <th>Estado</th>
              <th class="right">Acciones</th>
            </tr>
          </thead>

          <tbody>
            <tr *ngFor="let u of filtered">
              <td class="name">
                <div class="avatar">{{ (u.username || 'U').slice(0, 1) | uppercase }}</div>
                <div>
                  <div class="full">{{ u.fullName }}</div>
                  <div class="mini">ID: {{ getId(u) }}</div>
                </div>
              </td>

              <td class="mono">{{ u.username }}</td>

              <td>
                <span class="tag" [class.admin]="u.role === 'ADMIN'">{{ u.role }}</span>
              </td>

              <td>
                <span class="pill" [class.off]="!(u.isActive ?? true)">
                  <span class="s-dot" [class.off]="!(u.isActive ?? true)"></span>
                  {{ u.isActive ?? true ? 'Activo' : 'Inactivo' }}
                </span>
              </td>

              <td class="right actions">
                <button class="btn tiny ghost" type="button" (click)="toggleActive(u)">
                  {{ u.isActive ?? true ? 'Desactivar' : 'Activar' }}
                </button>
                <button class="btn tiny ghost" type="button" (click)="openEdit(u)">Editar</button>
                <button class="btn tiny danger" type="button" (click)="openDelete(u)">
                  Eliminar
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- MODAL EDITAR -->
  <div class="modal-backdrop" *ngIf="editOpen" (click)="closeEdit()"></div>

  <div class="modal" *ngIf="editOpen">
    <div class="modal-card" (click)="$event.stopPropagation()">
      <div class="modal-title">Editar usuario</div>

      <div class="modal-body">
        <div class="row">
          <div class="field">
            <label>Nombre completo</label>
            <input [(ngModel)]="editForm.fullName" />
          </div>
          <div class="field">
            <label>Usuario</label>
            <input [(ngModel)]="editForm.username" />
          </div>
        </div>

        <div class="row">
          <div class="field">
            <label>Rol</label>
            <select [(ngModel)]="editForm.role">
              <option [ngValue]="'USER'">USER</option>
              <option [ngValue]="'ADMIN'">ADMIN</option>
            </select>
          </div>

          <div class="field">
            <label>Nueva contraseña (opcional)</label>
            <input
              [(ngModel)]="editForm.password"
              type="password"
              placeholder="Deja vacío para no cambiar"
            />
          </div>
        </div>

        <div class="inline-err" *ngIf="editError">{{ editError }}</div>
      </div>

      <div class="modal-actions">
        <button class="btn ghost" type="button" (click)="closeEdit()" [disabled]="savingEdit">
          Cancelar
        </button>
        <button class="btn primary" type="button" (click)="saveEdit()" [disabled]="savingEdit">
          <span class="spin" *ngIf="savingEdit"></span>
          {{ savingEdit ? 'Guardando…' : 'Guardar cambios' }}
        </button>
      </div>
    </div>
  </div>

  <!-- MODAL ELIMINAR -->
  <div class="modal-backdrop" *ngIf="deleteOpen" (click)="closeDelete()"></div>

  <div class="modal" *ngIf="deleteOpen">
    <div class="modal-card danger" (click)="$event.stopPropagation()">
      <div class="modal-title">Confirmar eliminación</div>

      <div class="modal-body">
        ¿Eliminar al usuario?
        <div class="mono big">{{ deleteTarget?.username }}</div>
        <div class="muted">
          Nombre: <b>{{ deleteTarget?.fullName }}</b> • Rol: <b>{{ deleteTarget?.role }}</b>
        </div>

        <div class="inline-err" *ngIf="deleteError">{{ deleteError }}</div>
      </div>

      <div class="modal-actions">
        <button class="btn ghost" type="button" (click)="closeDelete()" [disabled]="deleting">
          Cancelar
        </button>
        <button class="btn danger" type="button" (click)="confirmDelete()" [disabled]="deleting">
          <span class="spin" *ngIf="deleting"></span>
          {{ deleting ? 'Eliminando…' : 'Eliminar' }}
        </button>
      </div>
    </div>
  </div>
</div>
