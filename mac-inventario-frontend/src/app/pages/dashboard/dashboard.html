<div class="dash">
  <!-- HEADER -->
  <div class="header card">
    <div class="h-left">
      <div class="h-title">
        <div class="ttl">Dashboard Operativo</div>
        <div class="sub">Inventario centralizado por AP ‚Ä¢ Resumen y control</div>
      </div>

      <div class="meta">
        <span class="pill">
          <span class="dot ok"></span>
          Estado: <b>Operativo</b>
        </span>

        <span class="pill ghost">
          Usuario: <b>{{ userLabel }}</b>
        </span>

        <span class="pill role" [class.admin]="isAdmin">
          Rol: <b>{{ roleLabel }}</b>
        </span>

        <span class="pill ghost" *ngIf="lastUpdated as lu">
          Actualizado: <b>{{ lu | date : 'dd/MM/yyyy HH:mm' }}</b>
        </span>
      </div>
    </div>

    <div class="h-right">
      <button class="btn" type="button" (click)="refresh()" [disabled]="loading">
        <span class="spin" *ngIf="loading"></span>
        {{ loading ? 'Actualizando‚Ä¶' : 'Actualizar' }}
      </button>
    </div>

    <!-- decor -->
    <div class="fx-grid" aria-hidden="true"></div>
    <div class="fx-orb a" aria-hidden="true"></div>
    <div class="fx-orb b" aria-hidden="true"></div>
  </div>

  <!-- STATES -->
  <div *ngIf="loading" class="state card">
    <div class="pulse"></div>
    <div>
      <div class="st-ttl">Cargando informaci√≥n</div>
      <div class="st-sub">Obteniendo estad√≠sticas del inventario‚Ä¶</div>
    </div>
  </div>

  <div *ngIf="!loading && error" class="state card error">
    <div>
      <div class="st-ttl">No se pudo cargar</div>
      <div class="st-sub">{{ error }}</div>
    </div>
  </div>

  <div *ngIf="!loading && !error">
    <!-- KPI ROW -->
    <div class="kpi-row">
      <div class="kpi card">
        <div class="k-top">
          <div>
            <div class="k-lbl">Total registros</div>
            <div class="k-hint">MACs registradas</div>
          </div>
          <div class="k-ico">Œ£</div>
        </div>
        <div class="k-val">{{ total }}</div>
        <div class="k-foot">
          <span class="tag">MACs</span>
          <span class="muted">Fuente: DB</span>
        </div>
      </div>

      <div class="kpi card">
        <div class="k-top">
          <div>
            <div class="k-lbl">√Åreas</div>
            <div class="k-hint">Distribuci√≥n</div>
          </div>
          <div class="k-ico soft">‚ñ§</div>
        </div>
        <div class="k-val sm">{{ totalAreas }}</div>
        <div class="k-foot">
          <span class="tag soft">Molinos / Mina / Seguridad</span>
        </div>
      </div>

      <div class="kpi card">
        <div class="k-top">
          <div>
            <div class="k-lbl">Tipos</div>
            <div class="k-hint">Categor√≠as</div>
          </div>
          <div class="k-ico soft">‚óà</div>
        </div>
        <div class="k-val sm">{{ totalTypes }}</div>
        <div class="k-foot">
          <span class="tag soft">M√≥vil / Laptop / PC</span>
        </div>
      </div>

      <div class="kpi card">
        <div class="k-top">
          <div>
            <div class="k-lbl">APs</div>
            <div class="k-hint">Puntos activos</div>
          </div>
          <div class="k-ico soft">üì°</div>
        </div>
        <div class="k-val sm">{{ aps.length }}</div>
        <div class="k-foot">
          <button class="link" type="button" (click)="openApsModal()">Ver detalle</button>
        </div>
      </div>
    </div>

    <!-- MAIN GRID -->
    <div class="main-grid">
      <!-- LEFT: TOP APs -->
      <div class="card">
        <div class="card-head">
          <div>
            <div class="card-title">Top APs</div>
            <div class="card-sub">Los APs con m√°s registros</div>
          </div>
          <button class="btn ghost" type="button" (click)="openApsModal()">Ver todos</button>
        </div>

        <div class="top-aps">
          <div class="row" *ngFor="let x of topAps; trackBy: trackByAp">
            <div class="r-left">
              <div class="ap">{{ x.ap }}</div>
              <div class="sub">{{ x.count }} registros ‚Ä¢ {{ x.percent }}%</div>
            </div>

            <div class="bar" aria-hidden="true">
              <div class="fill" [style.width.%]="x.percent"></div>
            </div>

            <div class="r-right">{{ x.percent }}%</div>
          </div>

          <div class="empty" *ngIf="topAps.length === 0">No hay datos de AP todav√≠a.</div>
        </div>
      </div>

      <!-- RIGHT: AREA + TYPE + LOGS -->
      <div class="stack">
        <!-- Area distribution -->
        <div class="card">
          <div class="card-head">
            <div>
              <div class="card-title">Distribuci√≥n por √°rea</div>
              <div class="card-sub">Participaci√≥n sobre el total</div>
            </div>
          </div>

          <div class="mini-bars">
            <div class="mrow">
              <div class="ml">Molinos</div>
              <div class="mb">
                <div class="mf" [style.width.%]="areaPercent('MOLINOS')"></div>
              </div>
              <div class="mr">{{ byArea.MOLINOS }} ({{ areaPercent('MOLINOS') }}%)</div>
            </div>

            <div class="mrow">
              <div class="ml">Mina</div>
              <div class="mb">
                <div class="mf" [style.width.%]="areaPercent('MINA')"></div>
              </div>
              <div class="mr">{{ byArea.MINA }} ({{ areaPercent('MINA') }}%)</div>
            </div>

            <div class="mrow">
              <div class="ml">Seguridad</div>
              <div class="mb">
                <div class="mf" [style.width.%]="areaPercent('SEGURIDAD')"></div>
              </div>
              <div class="mr">{{ byArea.SEGURIDAD }} ({{ areaPercent('SEGURIDAD') }}%)</div>
            </div>
          </div>
        </div>

        <!-- Types -->
        <div class="card">
          <div class="card-head">
            <div>
              <div class="card-title">Dispositivos por tipo</div>
              <div class="card-sub">Resumen por categor√≠a</div>
            </div>
          </div>

          <div class="type-grid">
            <div class="tbox">
              <div class="t-top">
                <div class="t">{{ typeLabel('MOVIL') }}</div>
                <div class="ico">üì±</div>
              </div>
              <div class="v">{{ byType.MOVIL }}</div>
              <div class="hint">Tel√©fonos/tablets</div>
            </div>

            <div class="tbox">
              <div class="t-top">
                <div class="t">{{ typeLabel('LAPTOP') }}</div>
                <div class="ico">üíª</div>
              </div>
              <div class="v">{{ byType.LAPTOP }}</div>
              <div class="hint">Port√°tiles</div>
            </div>

            <div class="tbox">
              <div class="t-top">
                <div class="t">{{ typeLabel('PC') }}</div>
                <div class="ico">üñ•</div>
              </div>
              <div class="v">{{ byType.PC }}</div>
              <div class="hint">Escritorio</div>
            </div>
          </div>
        </div>

        <!-- Logs -->
        <div class="card" *ngIf="isAdmin">
          <div class="card-head">
            <div>
              <div class="card-title">Bit√°cora</div>
              <div class="card-sub">Acciones recientes (ADMIN)</div>
            </div>
          </div>

          <div class="logs">
            <div class="log" *ngFor="let l of logs; trackBy: trackByLog">
              <div class="l-left">
                <span class="badge" [class]="actionClass(l.action)">{{ l.action }}</span>
              </div>

              <div class="l-main">
                <div class="l-ttl">{{ l.message }}</div>
                <div class="l-sub">
                  <b>{{ l.userName }}</b> ({{ l.role }}) ‚Ä¢ IP: {{ formatIp(l.ip) }} ‚Ä¢
                  {{ l.createdAt | date : 'dd/MM/yyyy HH:mm' }}
                </div>
              </div>
            </div>

            <div class="empty" *ngIf="logs.length === 0">No hay acciones registradas todav√≠a.</div>
          </div>
        </div>

        <div class="card" *ngIf="!isAdmin">
          <div class="empty">Vista de bit√°cora disponible solo para administradores.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL: todos los APs -->
  <div class="modal-backdrop" *ngIf="apsModalOpen" (click)="closeApsModal()"></div>

  <div class="modal" *ngIf="apsModalOpen">
    <div class="modal-card" (click)="$event.stopPropagation()">
      <div class="m-head">
        <div>
          <div class="m-title">Distribuci√≥n por AP</div>
          <div class="m-sub">Listado completo</div>
        </div>
        <button class="btn ghost" type="button" (click)="closeApsModal()">Cerrar</button>
      </div>

      <div class="m-list">
        <div class="m-row" *ngFor="let x of allApsSorted; trackBy: trackByAp">
          <div class="m-ap">{{ x.ap }}</div>
          <div class="m-bar"><div class="m-fill" [style.width.%]="x.percent"></div></div>
          <div class="m-n">{{ x.count }} ‚Ä¢ {{ x.percent }}%</div>
        </div>
      </div>
    </div>
  </div>
</div>
