<div class="page">
  <div class="head">
    <div class="h-left">
      <h2>{{ title() }}</h2>
      <div class="sub">{{ subtitle() }}</div>
    </div>

    <div class="h-actions">
      <button class="btn ghost" type="button" (click)="exportExcel()">Exportar</button>
      <button class="btn ghost" type="button" (click)="importExcel()">Importar</button>
      <button class="btn" type="button" (click)="newDevice()">+ Nuevo</button>
    </div>
  </div>

  <!-- ✅ ERROR visible (sin alert) -->
  <div *ngIf="errorMsg" class="alert error">
    <div class="a-title">Atención</div>
    <div class="a-sub">{{ errorMsg }}</div>
  </div>

  <div class="toolbar card">
    <div class="search">
      <div class="searchbox">
        <span class="s-ic">⌕</span>
        <input
          [(ngModel)]="q"
          placeholder="Buscar por MAC, dueño, punto, AP o registrado por…"
          (keyup.enter)="search()"
        />
      </div>

      <button class="btn" type="button" (click)="search()">Buscar</button>
      <button class="btn ghost" type="button" (click)="clear()">Limpiar</button>
    </div>

    <div class="meta">
      <div class="pill">
        Registros: <b>{{ devices.length }}</b>
      </div>
      <div class="pill">
        Página: <b>{{ page }}</b> / {{ totalPages }}
      </div>

      <div class="pill">
        Ver:
        <select [(ngModel)]="pageSize" (ngModelChange)="page = 1">
          <option [ngValue]="10">10</option>
          <option [ngValue]="20">20</option>
          <option [ngValue]="50">50</option>
        </select>
      </div>
    </div>
  </div>

  <div *ngIf="loading" class="state card">Cargando inventario…</div>

  <div *ngIf="!loading && devices.length > 0" class="table card">
    No hay registros.
  </div>

  <!-- Table -->
  <div *ngIf="!loading && devices.length > 0" class="table card">
    <table>
      <thead>
        <tr>
          <th (click)="setSort('createdAt')">Fecha</th>
          <th (click)="setSort('apName')">AP</th>
          <th (click)="setSort('ownerName')">Dueño</th>
          <th (click)="setSort('mac')">MAC</th>
          <th (click)="setSort('deviceType')">Tipo</th>
          <th (click)="setSort('area')">Área</th>
          <th (click)="setSort('locationPoint')">Punto</th>
          <th (click)="setSort('registeredByName')">Registrado por</th>
          <th class="right">Acciones</th>
        </tr>
      </thead>

      <tbody>
        <tr *ngFor="let d of paged">
          <td class="mono">{{ d.createdAt | date : 'dd/MM/yyyy HH:mm' }}</td>

          <td>
            <span class="tag ap">{{ d.apName }}</span>
          </td>

          <td class="cut">{{ d.ownerName }}</td>
          <td class="mono">{{ d.mac }}</td>

          <td>
            <span class="tag">{{ d.deviceType }}</span>
          </td>

          <td>
            <span class="tag soft">{{ d.area }}</span>
          </td>

          <td class="cut">{{ d.locationPoint }}</td>
          <td class="cut">{{ d.registeredByName || 'N/D' }}</td>

          <td class="right actions">
            <button class="btn tiny ghost" type="button" (click)="edit(d)">Editar</button>
            <button class="btn tiny danger" type="button" (click)="openDelete(d)">Eliminar</button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Pager -->
    <div class="pager">
      <button class="btn ghost" type="button" (click)="prev()" [disabled]="page <= 1">
        ← Anterior
      </button>
      <div class="pager-info">
        Página <b>{{ page }}</b> de {{ totalPages }}
      </div>
      <button class="btn ghost" type="button" (click)="next()" [disabled]="page >= totalPages">
        Siguiente →
      </button>
    </div>
  </div>

  <!-- ✅ MODAL ELIMINAR (solo si está abierto Y hay registro seleccionado) -->
  <div class="modal-backdrop" *ngIf="confirmOpen && toDelete" (click)="closeDelete()"></div>

  <div class="modal" *ngIf="confirmOpen && toDelete">
    <div class="modal-card" (click)="$event.stopPropagation()">
      <div class="modal-title">Confirmar eliminación</div>

      <div class="modal-body">
        ¿Deseas eliminar la MAC:
        <div class="mono big">{{ toDelete.mac }}</div>

        <div class="muted">
          AP: <b>{{ toDelete.apName }}</b> • Punto: <b>{{ toDelete.locationPoint }}</b>
        </div>

        <div class="merr" *ngIf="modalError">{{ modalError }}</div>
      </div>

      <div class="modal-actions">
        <button class="btn ghost" type="button" (click)="closeDelete()" [disabled]="deleting">
          Cancelar
        </button>

        <button class="btn danger" type="button" (click)="confirmDelete()" [disabled]="deleting">
          {{ deleting ? 'Eliminando…' : 'Eliminar' }}
        </button>
      </div>
    </div>
  </div>
</div>
